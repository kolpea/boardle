<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Departure Board Design Â· Barcelona</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0e0e0e; --surface: #161616; --surface2: #1f1f1f;
    --border: #2a2a2a; --text: #e8e8e8; --text-dim: #888; --accent: #fff;
  }
  body { background:var(--bg); color:var(--text); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; min-height:100vh; display:flex; flex-direction:column; }

  header { padding:24px 40px 18px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:14px; }
  .header-logo { width:48px; height:48px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
  .header-logo svg { width:48px; height:48px; }
  .header-title h1 { font-size:17px; font-weight:600; letter-spacing:-0.02em; color:var(--accent); line-height:1; }
  .header-title p { font-size:11px; color:var(--text-dim); margin-top:3px; letter-spacing:0.08em; text-transform:uppercase; }

  main { flex:1; display:grid; grid-template-columns:300px 1fr; }

  .controls-panel { border-right:1px solid var(--border); padding:28px 24px; display:flex; flex-direction:column; gap:20px; overflow-y:auto; }
  .control-group > label { display:block; font-size:10px; letter-spacing:0.12em; text-transform:uppercase; color:var(--text-dim); margin-bottom:8px; font-weight:500; }
  .select-wrapper { position:relative; }
  .select-wrapper::after { content:''; position:absolute; right:13px; top:50%; transform:translateY(-50%); border-left:4px solid transparent; border-right:4px solid transparent; border-top:5px solid var(--text-dim); pointer-events:none; }
  select { width:100%; appearance:none; background:var(--surface2); border:1px solid var(--border); border-radius:6px; color:var(--text); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:14px; padding:10px 34px 10px 13px; cursor:pointer; outline:none; transition:border-color 0.15s; }
  select:focus { border-color:#555; }
  select:disabled { opacity:0.3; cursor:not-allowed; }
  option { background:#1f1f1f; }


  .direction-buttons { display:flex; flex-direction:column; gap:8px; }
  .dir-btn { background:var(--surface2); border:1px solid var(--border); border-radius:8px; color:var(--text-dim); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:13px; padding:11px 14px; cursor:pointer; text-align:left; transition:all 0.15s; line-height:1.3; opacity:0.35; pointer-events:none; }
  .dir-btn.enabled { opacity:1; pointer-events:all; }
  .dir-btn.enabled:hover { border-color:#555; color:var(--text); background:#242424; }
  .dir-btn.active { border-color:#666; color:var(--accent); background:#222; }
  .dir-btn .dir-btn-label { font-size:9px; letter-spacing:0.1em; text-transform:uppercase; color:var(--text-dim); margin-bottom:3px; display:block; }

  .panel-divider { border:none; border-top:1px solid var(--border); }

  .cred-section { display:flex; flex-direction:column; gap:10px; }
  .cred-input-group { display:flex; flex-direction:column; gap:6px; }
  .cred-input-group label { font-size:10px; letter-spacing:0.1em; text-transform:uppercase; color:var(--text-dim); font-weight:500; }
  .cred-input { width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:6px; color:var(--text); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:13px; padding:9px 13px; outline:none; transition:border-color 0.15s; }
  .cred-input:focus { border-color:#555; }
  .cred-input::placeholder { color:#444; }
  .cred-hint { font-size:11px; color:var(--text-dim); line-height:1.5; }
  .cred-hint a { color:#6b9bd2; text-decoration:none; }
  .cred-hint a:hover { text-decoration:underline; }

  .status-row { display:flex; align-items:center; gap:8px; font-size:12px; color:var(--text-dim); }
  .status-dot { width:6px; height:6px; border-radius:50%; background:#3a3a3a; flex-shrink:0; }
  .status-dot.ready { background:#22c55e; box-shadow:0 0 6px #22c55e88; }
  .status-dot.partial { background:#eab308; }
  .status-dot.loading { background:#3b82f6; animation:pulse 1s infinite; }
  .status-dot.error { background:#ef4444; }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }

  .preview-panel { padding:28px 32px; display:flex; flex-direction:column; gap:20px; }
  .preview-label { font-size:10px; letter-spacing:0.12em; text-transform:uppercase; color:var(--text-dim); font-weight:500; }
  .screen-preview-wrapper { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:28px; display:flex; align-items:center; justify-content:center; min-height:200px; }
  .screen-placeholder { text-align:center; color:var(--text-dim); }
  .screen-placeholder .icon { font-size:36px; opacity:0.25; margin-bottom:10px; }
  .screen-placeholder strong { color:var(--text); display:block; font-size:14px; margin-bottom:5px; }
  .screen-placeholder p { font-size:12px; line-height:1.6; }
  #preview-scale-root { display:none; position:relative; overflow:hidden; }

  .btn-fullscreen { display:inline-flex; align-items:center; gap:8px; padding:10px 18px; background:transparent; border:1px solid var(--border); border-radius:6px; color:var(--text-dim); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:13px; cursor:pointer; transition:all 0.15s; align-self:flex-start; }
  .btn-fullscreen:hover:not(:disabled) { border-color:#555; color:var(--text); background:var(--surface2); }
  .btn-fullscreen:disabled { opacity:0.3; cursor:not-allowed; }
  .btn-fullscreen svg { width:13px; height:13px; flex-shrink:0; }

  .refresh-row { display:flex; align-items:center; gap:10px; font-size:12px; color:var(--text-dim); }
  .refresh-dot { width:6px; height:6px; border-radius:50%; background:#22c55e; flex-shrink:0; }
  .refresh-dot.live { animation:pulse 2s infinite; }
  .btn-refresh { background:transparent; border:1px solid var(--border); border-radius:4px; color:var(--text-dim); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:11px; padding:4px 10px; cursor:pointer; transition:all 0.15s; }
  .btn-refresh:hover { border-color:#555; color:var(--text); }

  #fs-overlay { display:none; position:fixed; inset:0; z-index:9999; background:#000; align-items:center; justify-content:center; }
  #fs-overlay.active { display:flex; }

  .board-canvas { width:1920px; height:540px; position:relative; background:#fff; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; transform-origin:top left; flex-shrink:0; overflow:hidden; }

  .b-sidebar { position:absolute; left:0; top:0; width:150px; height:540px; background:#000; }
  .b-metro-logo { position:absolute; left:25px; top:40px; width:100px; height:100px; line-height:0; }
  .b-clock { position:absolute; left:0; width:150px; bottom:40px; text-align:center; color:#fff; font-size:40px; font-weight:500; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; line-height:1; }
  .b-line-icon { position:absolute; left:172px; top:40px; width:100px; height:100px; line-height:0; }
  .b-direccio { position:absolute; left:292px; top:40px; color:#000; font-size:32px; font-weight:400; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; line-height:1; }
  .b-terminus { position:absolute; left:292px; top:68px; color:#000; font-size:72px; font-weight:700; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; line-height:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:1580px; }
  .b-circle-1 { position:absolute; left:172px; top:240px; width:100px; height:100px; border-radius:50%; background:#D9D9D9; display:flex; align-items:center; justify-content:center; }
  .b-circle-num { color:#000; font-size:80px; font-weight:500; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; line-height:1; }
  .b-time-1 { position:absolute; left:292px; color:#000; font-size:200px; font-weight:700; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; line-height:1; top:190px; }
  .b-circle-2 { position:absolute; left:1142px; top:240px; width:100px; height:100px; border-radius:50%; background:#D9D9D9; display:flex; align-items:center; justify-content:center; }
  .b-time-2 { position:absolute; left:1262px; color:#000; font-size:200px; font-weight:700; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; line-height:1; top:190px; }

  .custom-times-section { display:flex; flex-direction:column; gap:10px; }
  .custom-times-row { display:flex; flex-direction:column; gap:6px; }
  .custom-times-row label { font-size:10px; letter-spacing:0.1em; text-transform:uppercase; color:var(--text-dim); font-weight:500; }
  .custom-time-input-wrap { position:relative; display:flex; align-items:center; }
  .custom-time-input {
    width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:6px;
    color:var(--text); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;
    font-size:20px; font-weight:700; letter-spacing:0.06em;
    padding:10px 36px 10px 13px; outline:none; transition:border-color 0.15s;
  }
  .custom-time-input:focus { border-color:#555; }
  .custom-time-input::placeholder { color:#383838; font-weight:400; font-size:13px; letter-spacing:0; }
  .custom-time-input.has-value { border-color:#555; color:#fff; }
  .btn-clear-time { position:absolute; right:10px; background:none; border:none; color:#444; cursor:pointer; font-size:15px; line-height:1; padding:2px 5px; transition:color 0.15s; display:none; }
  .btn-clear-time.visible { display:block; }
  .btn-clear-time:hover { color:#888; }
  .custom-times-hint { font-size:11px; color:var(--text-dim); line-height:1.5; }
</style>
</head>
<body>

<header>
  <div class="header-logo">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <rect x="4" y="3" width="16" height="18" rx="3" stroke="white" stroke-width="1.5"/>
      <rect x="7" y="6" width="10" height="7" rx="1.5" stroke="white" stroke-width="1.5"/>
      <path d="M8 21L10.5 18M16 21L13.5 18" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
    </svg>  </div>
  <div class="header-title">
    <h1>Departure Board Design</h1>
    <p>Barcelona Metro Â· Unofficial</p>
  </div>
</header>

<main>
  <aside class="controls-panel">

    <div class="cred-section">
      <div class="cred-input-group">
        <label>TMB App ID</label>
        <input class="cred-input" id="inp-app-id" type="text" placeholder="e.g. a1b2c3d4" autocomplete="off" spellcheck="false">
      </div>
      <div class="cred-input-group">
        <label>TMB App Key</label>
        <input class="cred-input" id="inp-app-key" type="password" placeholder="your app key" autocomplete="off" spellcheck="false">
      </div>
      <p class="cred-hint">Get free credentials at <a href="https://developer.tmb.cat" target="_blank">developer.tmb.cat</a></p>
    </div>

    <hr class="panel-divider">

    <div class="control-group">
      <label>Select Line</label>
      <div class="select-wrapper">
        <select id="sel-line">
          <option value="">â€” Select â€”</option>
          <option value="L1">L1</option>
          <option value="L2">L2</option>
          <option value="L3">L3</option>
          <option value="L4">L4</option>
          <option value="L5">L5</option>
        </select>
      </div>
    </div>

    <hr class="panel-divider">

    <div class="control-group">
      <label>Select Station</label>
      <div class="select-wrapper">
        <select id="sel-station" disabled>
          <option value="">â€” Select line first â€”</option>
        </select>
      </div>
    </div>

    <hr class="panel-divider">

    <div class="control-group">
      <label>Select Direction</label>
      <div class="direction-buttons">
        <button class="dir-btn" id="dir-btn-0">
          <span class="dir-btn-label">Terminus A</span>
          <span class="dir-btn-name">â€”</span>
        </button>
        <button class="dir-btn" id="dir-btn-1">
          <span class="dir-btn-label">Terminus B</span>
          <span class="dir-btn-name">â€”</span>
        </button>
      </div>
    </div>

    <hr class="panel-divider">

    <div class="control-group">
      <label>Custom Times Override</label>
      <div class="custom-times-section">
        <div class="custom-times-row">
          <label>Next train</label>
          <div class="custom-time-input-wrap">
            <input class="custom-time-input" id="custom-time-1" type="text" placeholder="e.g. 03:22 or 4 min" maxlength="10" autocomplete="off" spellcheck="false">
            <button class="btn-clear-time" id="clear-time-1" title="Clear">âœ•</button>
          </div>
        </div>
        <div class="custom-times-row">
          <label>Train after</label>
          <div class="custom-time-input-wrap">
            <input class="custom-time-input" id="custom-time-2" type="text" placeholder="e.g. 08:47 or 9 min" maxlength="10" autocomplete="off" spellcheck="false">
            <button class="btn-clear-time" id="clear-time-2" title="Clear">âœ•</button>
          </div>
        </div>
        <p class="custom-times-hint">Overrides live data. Clear to restore.</p>
      </div>
    </div>


  </aside>

  <section class="preview-panel">
    <div class="preview-label">Screen Preview â€” 1920 Ã— 540 px (scaled)</div>
    <div class="status-row" id="status-row-wrap">
      <div class="status-dot" id="status-dot"></div>
      <span id="status-text">No selection made</span>
    </div>

    <div class="screen-preview-wrapper" id="screen-wrapper">
      <div class="screen-placeholder" id="placeholder">
        <div class="icon">ðŸš‡</div>
        <strong>No screen configured</strong>
        <p>Select a line, station, and direction<br>to preview the departure board.</p>
      </div>
      <div id="preview-scale-root"></div>
    </div>

    <div class="refresh-row" id="refresh-row" style="display:none;">
      <div class="refresh-dot live" id="refresh-dot"></div>
      <span id="refresh-label">Live Â· refreshes every 30s</span>
      <button class="btn-refresh" id="btn-refresh">â†» Refresh now</button>
    </div>

    <button class="btn-fullscreen" id="btn-fullscreen" disabled>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/>
        <line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/>
      </svg>
      Display in full screen
    </button>
  </section>
</main>

<div id="fs-overlay">
  <div id="fs-board-root" style="position:relative;overflow:hidden;"></div>
</div>

<script>
const LINES = {
  L1: {
    color:'#E3000F', textColor:'#fff', apiId: 1,
    termini: ['Hospital de Bellvitge', 'Fondo'],
    directionIds: [2, 1],
    stations: [
      {name:'Hospital de Bellvitge', id:3},
      {name:'Bellvitge', id:4},{name:'Av. Carrilet', id:5},{name:'Rambla Just Oliveras', id:6},
      {name:'Can Serra', id:7},{name:'Florida', id:8},{name:'Torrassa', id:9},
      {name:'Santa EulÃ lia', id:10},{name:'Mercat Nou', id:11},{name:'PlaÃ§a de Sants', id:12},
      {name:'Hostafrancs', id:13},{name:'Espanya', id:14},{name:'Rocafort', id:15},
      {name:'Urgell', id:16},{name:'Universitat', id:17},{name:'Catalunya', id:1},
      {name:'Urquinaona', id:18},{name:'Arc de Triomf', id:19},{name:'Marina', id:20},
      {name:'GlÃ²ries', id:21},{name:'Clot', id:22},{name:'Navas', id:23},
      {name:'La Sagrera', id:24},{name:'CongrÃ©s', id:25},{name:'Maragall', id:26},
      {name:'Vilapicina', id:27},{name:'Horta', id:28},{name:'Montbau', id:29},
      {name:"Vall d'Hebron", id:30},{name:'Penitents', id:31},{name:'Mundet', id:32},
      {name:'Coll i Alella', id:33},{name:'El Coll / La Teixonera', id:34},
      {name:'Roquetes', id:35},{name:'Trinitat Nova', id:36},{name:'BarÃ³ de Viver', id:37},
      {name:'Santa Coloma', id:38},{name:'SinguerlÃ­n', id:39},{name:'Fondo', id:40}
    ]
  },
  L2: {
    color:'#7B2D8B', textColor:'#fff', apiId: 2,
    termini: ['Badalona Pompeu Fabra', 'ParalÂ·lel'],
    directionIds: [1, 2],
    stations: [
      {name:'ParalÂ·lel', id:41},{name:'Sant Antoni', id:42},{name:'Universitat', id:43},
      {name:'Passeig de GrÃ cia', id:44},{name:'Tetuan', id:45},{name:'Monumental', id:46},
      {name:'Sagrada FamÃ­lia', id:47},{name:'Encants', id:48},{name:'Clot', id:49},
      {name:'Bac de Roda', id:50},{name:'Sant MartÃ­', id:51},{name:'La Pau', id:52},
      {name:'Verneda', id:53},{name:'Artigues / Sant AdriÃ ', id:54},{name:'Sant Roc', id:55},
      {name:'Gorg', id:56},{name:'Pep Ventura', id:57},{name:'Badalona Pompeu Fabra', id:58}
    ]
  },
  L3: {
    color:'#007F40', textColor:'#fff', apiId: 3,
    termini: ['Zona UniversitÃ ria', 'Trinitat Nova'],
    directionIds: [2, 1],
    stations: [
      {name:'Zona UniversitÃ ria', id:59},{name:'Palau Reial', id:60},
      {name:'Maria Cristina', id:61},{name:'Les Corts', id:62},{name:'Sants EstaciÃ³', id:63},
      {name:'Tarragona', id:64},{name:'Espanya', id:65},{name:'ParalÂ·lel', id:66},
      {name:'Drassanes', id:67},{name:'Liceu', id:68},{name:'Catalunya', id:69},
      {name:'Passeig de GrÃ cia', id:70},{name:'Diagonal', id:71},{name:'Fontana', id:72},
      {name:'GrÃ cia', id:73},{name:'Lesseps', id:74},{name:'Vallcarca', id:75},
      {name:'El Coll / La Teixonera', id:76},{name:'La Salut', id:77},
      {name:'Roquetes', id:78},{name:'Trinitat Nova', id:79}
    ]
  },
  L4: {
    color:'#FFC600', textColor:'#000', apiId: 4,
    termini: ['La Pau', 'Trinitat Nova'],
    directionIds: [2, 1],
    stations: [
      {name:'La Pau', id:80},{name:'BesÃ²s', id:81},{name:'BesÃ²s Mar', id:82},
      {name:'El Maresme / FÃ²rum', id:83},{name:'Selva de Mar', id:84},
      {name:'El Poblenou', id:85},{name:'Llacuna', id:86},{name:'Vila OlÃ­mpica', id:87},
      {name:'Ciutadella / Vila OlÃ­mpica', id:88},{name:'Barceloneta', id:89},
      {name:'Jaume I', id:90},{name:'Urquinaona', id:91},{name:'Passeig de GrÃ cia', id:92},
      {name:'Girona', id:93},{name:'Verdaguer', id:94},{name:'Joanic', id:95},
      {name:'Alfons X', id:96},{name:'GuinardÃ³ / Hospital de Sant Pau', id:97},
      {name:'Maragall', id:98},{name:'Llucmajor', id:99},{name:'Via JÃºlia', id:100},
      {name:'Trinitat Nova', id:101}
    ]
  },
  L5: {
    color:'#0065B3', textColor:'#fff', apiId: 5,
    termini: ['CornellÃ  Centre', "Vall d'Hebron"],
    directionIds: [2, 1],
    stations: [
      {name:'CornellÃ  Centre', id:102},{name:'Gavarra', id:103},{name:'Sant Ildefons', id:104},
      {name:'Can Boixeres', id:105},{name:'Can Vidalet', id:106},{name:'Pubilla Cases', id:107},
      {name:'Collblanc', id:108},{name:'Badal', id:109},{name:'PlaÃ§a de Sants', id:110},
      {name:'Sants EstaciÃ³', id:111},{name:'EntenÃ§a', id:112},{name:'Hospital ClÃ­nic', id:113},
      {name:'Diagonal', id:114},{name:'Verdaguer', id:115},{name:'Sagrada FamÃ­lia', id:116},
      {name:'Sant Pau / Dos de Maig', id:117},{name:"Camp de l'Arpa", id:118},
      {name:'La Sagrera', id:119},{name:'CongrÃ©s', id:120},{name:'Maragall', id:121},
      {name:'Horta', id:122},{name:'El Carmel', id:123},{name:'El Coll / La Teixonera', id:124},
      {name:'Montbau', id:125},{name:"Vall d'Hebron", id:126}
    ]
  }
};

const BOARD_W = 1920, BOARD_H = 540;

let state = { line:null, station:null, stationId:null, direction:null, directionIdx:null };
let departureTimes = [null, null];
let customOverride = [null, null];
let refreshTimer = null;
let lastRefreshed = null;

const inpAppId      = document.getElementById('inp-app-id');
const inpAppKey     = document.getElementById('inp-app-key');
const selLine       = document.getElementById('sel-line');
const selStation    = document.getElementById('sel-station');
const dirBtn0       = document.getElementById('dir-btn-0');
const dirBtn1       = document.getElementById('dir-btn-1');
const statusDot     = document.getElementById('status-dot');
const statusText    = document.getElementById('status-text');
const placeholder   = document.getElementById('placeholder');
const previewRoot   = document.getElementById('preview-scale-root');
const fsOverlay     = document.getElementById('fs-overlay');
const fsBoardRoot   = document.getElementById('fs-board-root');
const btnFull       = document.getElementById('btn-fullscreen');
const screenWrapper = document.getElementById('screen-wrapper');
const refreshRow    = document.getElementById('refresh-row');
const refreshLabel  = document.getElementById('refresh-label');
const btnRefresh    = document.getElementById('btn-refresh');
const customTime1   = document.getElementById('custom-time-1');
const customTime2   = document.getElementById('custom-time-2');
const clearTime1    = document.getElementById('clear-time-1');
const clearTime2    = document.getElementById('clear-time-2');

function metroLogoSVG() {
  return `<svg width="100" height="100" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
<rect width="100" height="100" fill="#ED1B2D"/>
<path d="M5 49.75L50 16L95 49.75L50 83.5" fill="white"/>
<path d="M50.0002 53.0225L44.682 35.0225H32.8184V64.8861H41.8184V46.0679L46.932 64.477H53.0684L58.182 46.0679V64.477H67.182V35.0225H55.3184" fill="#ED1B2D"/>
</svg>`;
}

const LINE_SVGS = {
  L1:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64.01 64" width="100" height="100"><rect fill="#DF2937" width="64.01" height="64"/><polygon fill="#FFF" points="16.443,15.258 16.443,42.626 32.817,42.626 32.817,48.85 9.057,48.85 9.057,15.258"/><path fill="#FFF" d="M45.47,48.844V27.491h-8.283V22.45c1.163,0.034,2.282-0.053,3.367-0.261c1.076-0.198,2.05-0.55,2.919-1.076c0.854-0.516,1.592-1.206,2.185-2.05c0.589-0.849,0.984-1.901,1.182-3.15h5.312v32.931H45.47z"/></svg>`,
  L2:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64.024 64" width="100" height="100"><rect fill="#993C8C" width="64.024" height="64"/><polygon fill="#FFF" points="14.757,15.256 14.757,42.64 31.135,42.64 31.135,48.855 7.369,48.855 7.369,15.256"/><path fill="#FFF" d="M34.422,23.326c0.507-1.612,1.25-3.021,2.263-4.237c0.999-1.206,2.268-2.152,3.783-2.823c1.525-0.68,3.272-1.009,5.25-1.009c1.501,0,2.939,0.232,4.3,0.705c1.361,0.473,2.572,1.153,3.6,2.031c1.042,0.878,1.858,1.94,2.471,3.238c0.618,1.293,0.922,2.731,0.922,4.333c0,1.645-0.261,3.084-0.801,4.28c-0.526,1.187-1.24,2.249-2.118,3.175c-0.878,0.931-1.868,1.766-2.987,2.509c-1.119,0.758-2.239,1.505-3.368,2.229c-1.129,0.748-2.229,1.539-3.281,2.384c-1.076,0.844-2.022,1.843-2.833,2.972h15.577v5.733h-24.18c0-1.92,0.26-3.58,0.82-4.985c0.55-1.419,1.289-2.678,2.229-3.788c0.946-1.119,2.041-2.138,3.325-3.083c1.264-0.946,2.601-1.901,4.02-2.876c0.724-0.492,1.491-0.999,2.306-1.515c0.811-0.526,1.559-1.095,2.239-1.723c0.666-0.627,1.226-1.341,1.689-2.128c0.449-0.782,0.68-1.67,0.68-2.669c0-1.612-0.463-2.852-1.385-3.745C48.011,21.439,46.823,21,45.386,21c-0.965,0-1.8,0.232-2.466,0.68c-0.671,0.449-1.221,1.042-1.626,1.79c-0.405,0.733-0.704,1.544-0.869,2.437c-0.174,0.898-0.261,1.776-0.261,2.664h-6.403C33.708,26.694,33.93,24.928,34.422,23.326"/></svg>`,
  L3:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 63.99 64" width="100" height="100"><rect fill="#3AA83E" width="63.99" height="64"/><polygon fill="#FFF" points="15.593,15.26 15.593,42.634 31.964,42.634 31.964,48.847 8.208,48.847 8.208,15.26"/><path fill="#FFF" d="M45.884,29.232c0.81-0.067,1.582-0.241,2.281-0.55c0.704-0.294,1.274-0.724,1.736-1.283c0.449-0.569,0.69-1.327,0.69-2.258c0-1.408-0.473-2.494-1.418-3.251c-0.94-0.757-2.016-1.129-3.246-1.129c-1.688,0-2.971,0.56-3.83,1.669c-0.864,1.119-1.283,2.523-1.249,4.211h-6.343c0.058-1.688,0.362-3.236,0.911-4.63c0.56-1.394,1.317-2.6,2.306-3.599c0.998-1.008,2.171-1.775,3.555-2.325c1.38-0.55,2.918-0.825,4.607-0.825c1.317,0,2.634,0.198,3.95,0.584c1.317,0.395,2.499,0.989,3.555,1.765c1.042,0.791,1.896,1.746,2.557,2.866c0.67,1.128,0.998,2.436,0.998,3.917c0,1.592-0.395,3.005-1.163,4.226c-0.772,1.225-1.92,2.05-3.458,2.489v0.097c1.823,0.41,3.251,1.288,4.293,2.634c1.018,1.351,1.544,2.966,1.544,4.843c0,1.732-0.338,3.266-1.018,4.606c-0.661,1.351-1.568,2.48-2.701,3.391c-1.119,0.912-2.422,1.602-3.893,2.06c-1.481,0.473-3.02,0.714-4.621,0.714c-1.843,0-3.531-0.275-5.046-0.801c-1.539-0.526-2.822-1.307-3.888-2.325c-1.061-1.022-1.886-2.262-2.465-3.743c-0.594-1.466-0.859-3.159-0.825-5.079h6.353c0.034,0.878,0.164,1.722,0.42,2.513c0.241,0.801,0.613,1.491,1.076,2.074c0.468,0.579,1.061,1.042,1.765,1.384c0.714,0.347,1.544,0.526,2.523,0.526c1.505,0,2.764-0.463,3.806-1.394c1.032-0.921,1.548-2.185,1.548-3.786c0-1.249-0.241-2.205-0.723-2.865c-0.497-0.656-1.11-1.138-1.867-1.438c-0.748-0.294-1.568-0.468-2.47-0.511c-0.887-0.048-1.741-0.077-2.556-0.077v-4.699C44.292,29.3,45.073,29.3,45.884,29.232"/></svg>`,
  L4:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64.024 64" width="100" height="100"><rect fill="#FCBE00" width="64.024" height="64"/><polygon fill="#1D1D1B" points="15.606,15.251 15.606,42.636 31.983,42.636 31.983,48.851 8.218,48.851 8.218,15.251"/><path fill="#1D1D1B" d="M33.623,41.224v-6.123l14.312-19.201h5.974v19.823h4.377v5.501h-4.377v7.615h-6.345v-7.615H33.623z M47.409,24.287l-8.507,11.436h8.662V24.287H47.409z"/></svg>`,
  L5:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 63.99 64" width="100" height="100"><rect fill="#0177BC" width="63.99" height="64"/><polygon fill="#FFF" points="15.585,15.252 15.585,42.626 31.956,42.626 31.956,48.839 8.209,48.839 8.209,15.252"/><path fill="#FFF" d="M42.78,21.413l-1.317,7.482l0.096,0.092c0.912-0.911,1.877-1.558,2.909-1.944c1.032-0.396,2.219-0.603,3.536-0.603c1.621,0,3.073,0.309,4.322,0.897c1.249,0.603,2.316,1.394,3.184,2.407c0.854,1.008,1.51,2.18,1.973,3.555c0.449,1.36,0.68,2.807,0.68,4.341c0,1.693-0.338,3.271-0.989,4.732c-0.666,1.457-1.544,2.721-2.663,3.782c-1.109,1.066-2.407,1.891-3.873,2.47c-1.481,0.584-3.053,0.859-4.708,0.825c-1.592,0-3.126-0.207-4.587-0.637c-1.461-0.43-2.754-1.076-3.873-1.954c-1.143-0.878-2.041-1.963-2.711-3.27c-0.68-1.293-1.032-2.808-1.061-4.544h6.681c0.164,1.515,0.724,2.711,1.698,3.613c0.97,0.887,2.209,1.336,3.71,1.336c0.878,0,1.678-0.174,2.373-0.545c0.723-0.352,1.302-0.825,1.785-1.409c0.497-0.579,0.868-1.249,1.143-2.026c0.26-0.772,0.395-1.558,0.395-2.373c0-0.844-0.135-1.645-0.376-2.392c-0.26-0.757-0.632-1.413-1.138-1.983c-0.507-0.56-1.085-0.999-1.78-1.317c-0.68-0.309-1.491-0.473-2.402-0.473c-1.196,0-2.161,0.217-2.909,0.646c-0.757,0.42-1.457,1.085-2.127,1.997h-6.01l3.246-18.204h18.388v5.499H42.78z"/></svg>`
};

function getCurrentTime() {
  return new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit',hour12:false});
}

function formatDeparture(seconds) {
  if (seconds === null || seconds === undefined) return 'â€”';
  if (seconds < 60) return 'A punt';
  const mins = Math.round(seconds / 60);
  if (mins <= 9) return `${mins} min`;
  const d = new Date(Date.now() + seconds * 1000);
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return `${hh}:${mm}`;
}

function getCredentials() {
  return { appId: inpAppId.value.trim(), appKey: inpAppKey.value.trim() };
}

function hasCredentials() {
  const { appId, appKey } = getCredentials();
  return appId.length > 0 && appKey.length > 0;
}

// â”€â”€â”€ TMB PROXY (via local server.js) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// All requests go to localhost:3000/tmb which forwards to api.tmb.cat
// and adds CORS headers. Run server.js with: node server.js

const PROXY = 'https://tmb-proxy.spamforjohnathan.workers.dev/';

async function tmbFetch(apiPath, params) {
  const qs = new URLSearchParams({ path: apiPath, ...params }).toString();
  const resp = await fetch(`${PROXY}?${qs}`);
  if (!resp.ok) throw new Error(`TMB ${resp.status} on ${apiPath}`);
  return resp.json();
}

// Cache: lineApiId -> Map<stationName, realCodi>
const stationIdCache = {};

async function getRealStationId(lineApiId, stationName, appId, appKey) {
  if (!stationIdCache[lineApiId]) {
    console.log(`[TMB] Fetching station list for line ${lineApiId}...`);
    const json = await tmbFetch(`/v1/transit/linies/metro/${lineApiId}/estacions`, { app_id: appId, app_key: appKey });
    const map = {};
    (json.features || []).forEach(f => {
      const p = f.properties || {};
      if (p.NOM_ESTACIO && p.CODI_ESTACIO_LINIA != null) {
        map[p.NOM_ESTACIO.trim()] = p.CODI_ESTACIO_LINIA;
      }
    });
    console.log(`[TMB] Station map for L${lineApiId}:`, map);
    stationIdCache[lineApiId] = map;
  }
  const map = stationIdCache[lineApiId];
  // Exact match
  if (map[stationName] != null) return map[stationName];
  // Case-insensitive fallback
  const lower = stationName.toLowerCase();
  for (const [k, v] of Object.entries(map)) {
    if (k.toLowerCase() === lower) return v;
  }
  // Partial match fallback (handles accents/apostrophes differences)
  const stripped = s => s.toLowerCase().replace(/['â€™Â·Â·]/g, '').replace(/\s+/g, ' ').trim();
  const needle = stripped(stationName);
  for (const [k, v] of Object.entries(map)) {
    if (stripped(k) === needle) return v;
  }
  console.warn(`[TMB] Station not found: "${stationName}" in`, Object.keys(map));
  return null;
}

async function fetchDepartures() {
  if (!state.line || !state.station || state.directionIdx === null) return;

  const { appId, appKey } = getCredentials();
  if (!appId || !appKey) { departureTimes = [null, null]; updateBoard(); return; }

  const lineData = LINES[state.line];
  const lineApiId = lineData.apiId;
  const dirCode = lineData.directionIds[state.directionIdx];

  setStatus('loading', 'Fetching live dataâ€¦');

  try {
    // Step 1: resolve the real station ID from the TMB station list
    const realId = await getRealStationId(lineApiId, state.station, appId, appKey);
    if (!realId) {
      setStatus('error', `Station not found: ${state.station}`);
      departureTimes = [null, null]; updateBoard(); return;
    }

    // Step 2: fetch real-time arrivals for that station
    console.log(`[TMB] Fetching imetro for station ${realId}, line ${lineApiId}, dir ${dirCode}`);
    const json = await tmbFetch(`/v1/imetro/estacions/${realId}`, { app_id: appId, app_key: appKey });
    console.log('[TMB] Raw imetro response:', JSON.stringify(json).slice(0, 500));

    parseDepartures(json, lineApiId, dirCode);

  } catch (e) {
    console.error('[TMB] fetchDepartures error:', e);
    setStatus('error', e.message || 'Network error');
    departureTimes = [null, null]; updateBoard();
  }
}

function parseDepartures(json, lineApiId, dirCode) {
  // The imetro endpoint returns a GeoJSON FeatureCollection.
  // Each feature.properties contains:
  //   T_E        - seconds until arrival
  //   SENTIT     - direction (1 or 2)
  //   CODI_LINIA - numeric line ID

  let entries = [];
  try {
    entries = (json.features || []).map(f => f.properties || {});
  } catch(e) { entries = []; }

  console.log(`[TMB] Total entries: ${entries.length}, filtering for line=${lineApiId} dir=${dirCode}`);
  entries.forEach(p => console.log(`  T_E=${p.T_E} SENTIT=${p.SENTIT} LINIA=${p.CODI_LINIA}`));

  // Filter by line and direction, extract seconds
  let times = entries
    .filter(p => {
      const lineOk = !lineApiId || String(p.CODI_LINIA) === String(lineApiId);
      const dirOk  = String(p.SENTIT) === String(dirCode);
      return lineOk && dirOk;
    })
    .map(p => Number(p.T_E))
    .filter(v => !isNaN(v) && v >= 0)
    .sort((a, b) => a - b);

  console.log(`[TMB] Matching times (line+dir): ${times}`);

  // If nothing matched on direction, show all times for this line
  if (times.length === 0) {
    times = entries
      .filter(p => !lineApiId || String(p.CODI_LINIA) === String(lineApiId))
      .map(p => Number(p.T_E))
      .filter(v => !isNaN(v) && v >= 0)
      .sort((a, b) => a - b);
    console.log(`[TMB] Fallback (line only) times: ${times}`);
  }

  departureTimes = [times[0] ?? null, times[1] ?? null];
  lastRefreshed = new Date();
  setStatus('ready', `${state.line} Â· ${state.station} â†’ ${state.direction}`);
  updateBoard();
  updateRefreshLabel();
}

function startRefreshCycle() {
  stopRefreshCycle();
  fetchDepartures();
  refreshTimer = setInterval(() => {
    fetchDepartures();
  }, 30000);
}

function stopRefreshCycle() {
  if (refreshTimer) { clearInterval(refreshTimer); refreshTimer = null; }
}

function updateRefreshLabel() {
  if (!lastRefreshed) return;
  const s = Math.round((Date.now() - lastRefreshed) / 1000);
  refreshLabel.textContent = s < 5 ? 'Live Â· just refreshed' : `Live Â· refreshed ${s}s ago`;
}
setInterval(updateRefreshLabel, 5000);

selLine.addEventListener('change', () => {
  const k = selLine.value;
  state = { line: k||null, station:null, stationId:null, direction:null, directionIdx:null };
  departureTimes = [null, null];
  stopRefreshCycle();

  if (k) {
    const l = LINES[k];
    selStation.innerHTML = '<option value="">â€” Select station â€”</option>';
    l.stations.forEach(s => {
      const o = document.createElement('option');
      o.value = s.id; o.textContent = s.name; selStation.appendChild(o);
    });
    selStation.disabled = false;
  } else {
    selStation.innerHTML = '<option value="">â€” Select line first â€”</option>';
    selStation.disabled = true;
  }
  resetDirBtns(); updateStatus(); updateScreen();
});

selStation.addEventListener('change', () => {
  const stId = selStation.value ? Number(selStation.value) : null;
  const stName = selStation.options[selStation.selectedIndex]?.text || null;
  state.stationId = stId;
  state.station = stName === 'â€” Select station â€”' ? null : stName;
  state.direction = null; state.directionIdx = null;
  departureTimes = [null, null];
  stopRefreshCycle();

  if (state.line && state.stationId) {
    const t = LINES[state.line].termini;
    [dirBtn0, dirBtn1].forEach((btn, i) => {
      btn.querySelector('.dir-btn-name').textContent = t[i];
      btn.classList.add('enabled'); btn.classList.remove('active');
    });
  } else { resetDirBtns(); }
  updateStatus(); updateScreen();
});

[dirBtn0, dirBtn1].forEach((btn, i) => {
  btn.addEventListener('click', () => {
    if (!btn.classList.contains('enabled')) return;
    state.direction = btn.querySelector('.dir-btn-name').textContent;
    state.directionIdx = i;
    [dirBtn0, dirBtn1].forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    updateStatus(); updateScreen();
    if (hasCredentials()) {
      refreshRow.style.display = 'flex';
      startRefreshCycle();
    }
  });
});

[inpAppId, inpAppKey].forEach(inp => {
  inp.addEventListener('change', () => {
    if (state.direction && hasCredentials()) {
      refreshRow.style.display = 'flex';
      startRefreshCycle();
    }
  });
});

btnRefresh.addEventListener('click', () => {
  if (state.direction && hasCredentials()) fetchDepartures();
});

function resetDirBtns() {
  [dirBtn0, dirBtn1].forEach((btn, i) => {
    btn.querySelector('.dir-btn-name').textContent = 'â€”';
    btn.querySelector('.dir-btn-label').textContent = i===0 ? 'Terminus A' : 'Terminus B';
    btn.classList.remove('enabled','active');
  });
}

function setStatus(type, msg) {
  statusText.textContent = msg;
  statusDot.className = 'status-dot';
  if (type === 'ready') statusDot.classList.add('ready');
  else if (type === 'partial') statusDot.classList.add('partial');
  else if (type === 'loading') statusDot.classList.add('loading');
  else if (type === 'error') statusDot.classList.add('error');
}

function updateStatus() {
  const {line,station,direction} = state;
  if (direction) {
    if (!hasCredentials()) {
      setStatus('partial', `${line} Â· ${station} â†’ ${direction} (no API keys)`);
    } else {
      setStatus('loading', 'Fetching live dataâ€¦');
    }
    btnFull.disabled = false;
  } else if (station) {
    setStatus('partial', 'Select a direction to continue');
    btnFull.disabled = true;
  } else if (line) {
    setStatus('', 'Select a station');
    btnFull.disabled = true;
  } else {
    setStatus('', 'No selection made');
    btnFull.disabled = true;
  }
}

function resolveDisplayTimes() {
  const liveT1 = departureTimes[0] !== null ? formatDeparture(departureTimes[0]) : null;
  const liveT2 = departureTimes[1] !== null ? formatDeparture(departureTimes[1]) : null;
  const t1 = customOverride[0] !== null ? customOverride[0] : (liveT1 !== null ? liveT1 : 'xx:xx');
  const t2 = customOverride[1] !== null ? customOverride[1] : (liveT2 !== null ? liveT2 : 'xx:xx');
  return [t1, t2];
}

function buildBoard(line, direction) {
  const [t1, t2] = resolveDisplayTimes();
  const clockTime = getCurrentTime();

  return `<div class="board-canvas">
    <div class="b-sidebar"></div>
    <div class="b-metro-logo">${metroLogoSVG()}</div>
    <div class="b-clock board-clock-el">${clockTime}</div>
    <div class="b-line-icon">${LINE_SVGS[line]}</div>
    <div class="b-direccio">DirecciÃ³</div>
    <div class="b-terminus">${direction}</div>
    <div class="b-circle-1"><span class="b-circle-num">1</span></div>
    <div class="b-time-1">${t1}</div>
    <div class="b-circle-2"><span class="b-circle-num">2</span></div>
    <div class="b-time-2">${t2}</div>
  </div>`;
}

function updateScreen() {
  if (state.line && state.station && state.direction) {
    placeholder.style.display = 'none';
    previewRoot.style.display = 'block';
    renderPreview();
  } else {
    placeholder.style.display = 'block';
    previewRoot.style.display = 'none';
    refreshRow.style.display = 'none';
    stopRefreshCycle();
  }
}

function updateBoard() {
  if (state.line && state.station && state.direction) {
    renderPreview();
    if (fsOverlay.classList.contains('active')) renderFullscreen();
  }
}

function renderPreview() {
  const availW = screenWrapper.clientWidth - 56;
  const previewW = Math.min(availW, 480);
  const scale = previewW / BOARD_W;
  const previewH = BOARD_H * scale;

  previewRoot.style.width = previewW + 'px';
  previewRoot.style.height = previewH + 'px';
  previewRoot.style.borderRadius = '3px';
  previewRoot.style.boxShadow = '0 3px 20px #0009';

  previewRoot.innerHTML = buildBoard(state.line, state.direction);
  const canvas = previewRoot.querySelector('.board-canvas');
  canvas.style.transform = `scale(${scale})`;
  canvas.style.position = 'absolute';
  canvas.style.top = '0'; canvas.style.left = '0';

  requestAnimationFrame(() => adjustCircle2(previewRoot, scale));
}

function adjustCircle2(container, scale) {
  const time1El = container.querySelector('.b-time-1');
  const circle2El = container.querySelector('.b-circle-2');
  const time2El = container.querySelector('.b-time-2');
  if (!time1El || !circle2El || !time2El) return;

  const canvasRect = container.querySelector('.board-canvas').getBoundingClientRect();
  const t1Rect = time1El.getBoundingClientRect();
  const nativeRight = (t1Rect.left - canvasRect.left + t1Rect.width) / scale;
  const c2Left = nativeRight + 250;
  circle2El.style.left = c2Left + 'px';
  time2El.style.left = (c2Left + 100 + 20) + 'px';
}

function applyCustomInput(inp, clearBtn, idx) {
  const val = inp.value.trim();
  customOverride[idx] = val.length > 0 ? val : null;
  const hasVal = customOverride[idx] !== null;
  inp.classList.toggle('has-value', hasVal);
  clearBtn.classList.toggle('visible', hasVal);
  updateBoard();
}

[customTime1, customTime2].forEach((inp, idx) => {
  const clearBtn = idx === 0 ? clearTime1 : clearTime2;
  inp.addEventListener('input', () => applyCustomInput(inp, clearBtn, idx));
  inp.addEventListener('change', () => applyCustomInput(inp, clearBtn, idx));
});

clearTime1.addEventListener('click', () => {
  customTime1.value = ''; applyCustomInput(customTime1, clearTime1, 0);
});
clearTime2.addEventListener('click', () => {
  customTime2.value = ''; applyCustomInput(customTime2, clearTime2, 1);
});

btnFull.addEventListener('click', () => {
  renderFullscreen();
  fsOverlay.classList.add('active');
  if (fsOverlay.requestFullscreen) fsOverlay.requestFullscreen();
  else if (fsOverlay.webkitRequestFullscreen) fsOverlay.webkitRequestFullscreen();
});

function renderFullscreen() {
  const vw = window.screen.width;
  const vh = window.screen.height;
  const scale = Math.min(vw / BOARD_W, vh / BOARD_H);

  fsBoardRoot.style.width = (BOARD_W * scale) + 'px';
  fsBoardRoot.style.height = (BOARD_H * scale) + 'px';
  fsBoardRoot.style.overflow = 'hidden';

  fsBoardRoot.innerHTML = buildBoard(state.line, state.direction);
  const canvas = fsBoardRoot.querySelector('.board-canvas');
  canvas.style.transform = `scale(${scale})`;
  canvas.style.position = 'absolute';
  canvas.style.top = '0'; canvas.style.left = '0';

  requestAnimationFrame(() => adjustCircle2(fsBoardRoot, scale));
}

document.addEventListener('fullscreenchange', () => {
  if (!document.fullscreenElement) fsOverlay.classList.remove('active');
});
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    fsOverlay.classList.remove('active');
    if (document.fullscreenElement) document.exitFullscreen();
  }
});
fsOverlay.addEventListener('click', e => {
  if (e.target === fsOverlay) {
    fsOverlay.classList.remove('active');
    if (document.fullscreenElement) document.exitFullscreen();
  }
});

setInterval(() => {
  document.querySelectorAll('.board-clock-el').forEach(el => el.textContent = getCurrentTime());
}, 15000);

window.addEventListener('resize', () => {
  if (state.line && state.station && state.direction) renderPreview();
});
</script>
</body>
</html>